<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTFS Realtime Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        #map { height: 90vh; width: 100%; }
        #controls { padding: 10px; background: white; position: absolute; top: 10px; left: 10px; z-index: 1000; border-radius: 8px; }
        label { display: block; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div id="controls">
        <h4>Filter by Route</h4>
        <div id="routeFilters"></div>
    </div>

    <div id="map"></div>

    <script>
        var map = L.map('map').setView([45.8020, 15.9819], 13); // Zagreb

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        var markers = [];
        var allVehicles = [];
        var routeSet = new Set();
        var routeColors = {}; // Stores colors for each route

        // Define a train icon
        function getTrainIcon(routeID, color) {
            return L.divIcon({
                className: "custom-train-icon",
                html: `
                    <div style="position: relative; width: 40px; height: 40px;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="40" height="40">
                            <path fill="${color}" d="M96 0C43 0 0 43 0 96L0 352c0 48 35.2 87.7 81.1 94.9l-46 46C28.1 499.9 33.1 512 43 512l39.7 0c8.5 0 16.6-3.4 22.6-9.4L160 448l128 0 54.6 54.6c6 6 14.1 9.4 22.6 9.4l39.7 0c10 0 15-12.1 7.9-19.1l-46-46c46-7.1 81.1-46.9 81.1-94.9l0-256c0-53-43-96-96-96L96 0zM64 96c0-17.7 14.3-32 32-32l256 0c17.7 0 32 14.3 32 32l0 96c0 17.7-14.3 32-32 32L96 224c-17.7 0-32-14.3-32-32l0-96zM224 288a48 48 0 1 1 0 96 48 48 0 1 1 0-96z"/>
                        </svg>
                        <span style="
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            font-size: 14px;
                            font-weight: bold;
                            color: white;
                            text-shadow: 1px 1px 2px black;
                        ">${routeID}</span>
                    </div>
                `,
                iconSize: [40, 40], // Adjust the icon size
                iconAnchor: [20, 20], // Center the icon
                popupAnchor: [0, -20] // Adjust popup position
            });
        }

        // Generate random color for a route if not already assigned
        function getRouteColor(routeID) {
            if (!routeColors[routeID]) {
                routeColors[routeID] = '#' + Math.floor(Math.random() * 16777215).toString(16); // Random hex color
            }
            return routeColors[routeID];
        }

        // Fetch vehicle data and update markers
        function updateVehicles() {
            fetch('/vehicles')
                .then(response => response.json())
                .then(data => {
                    allVehicles = data;
                    updateRouteFilters();
                    renderMarkers();
                })
                .catch(error => console.error("Error fetching vehicle data:", error));
        }

        // Generate route filter checkboxes with colors
        function updateRouteFilters() {
            let filterDiv = document.getElementById("routeFilters");

            // Store current checked states
            let checkedRoutes = new Set();
            document.querySelectorAll("#routeFilters input:checked").forEach(input => {
                checkedRoutes.add(input.value);
            });

            // Clear existing checkboxes
            filterDiv.innerHTML = "";
            routeSet.clear();
            allVehicles.forEach(v => routeSet.add(v.route_id));

            // Sort route IDs
            let sortedRoutes = Array.from(routeSet).sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));

            // Rebuild checkboxes
            sortedRoutes.forEach(routeID => {
                let color = getRouteColor(routeID);
                let label = document.createElement("label");
                let isChecked = checkedRoutes.has(routeID) ? "checked" : ""; // Preserve state
                label.innerHTML = `<input type="checkbox" value="${routeID}" ${isChecked}> <span style="color:${color}; font-weight:bold;">Route ${routeID}</span>`;
                filterDiv.appendChild(label);
            });

            // Reattach event listeners
            document.querySelectorAll("#routeFilters input").forEach(input => {
                input.addEventListener("change", renderMarkers);
            });
        }

        // Render train icons on the map
        function renderMarkers() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            let selectedRoutes = new Set();
            document.querySelectorAll("#routeFilters input:checked").forEach(input => {
                selectedRoutes.add(input.value);
            });

            allVehicles.forEach(vehicle => {
                if (selectedRoutes.has(vehicle.route_id)) {
                    let color = getRouteColor(vehicle.route_id);
                    let marker = L.marker([vehicle.lat, vehicle.lon], {
                        icon: getTrainIcon(vehicle.route_id, color)
                    })
                    .addTo(map)
                    .bindPopup(`<b>Route:</b> ${vehicle.route_id}`);

                    markers.push(marker);
                }
            });
        }

        // Fetch and update data every 10 seconds
        updateVehicles();
        setInterval(updateVehicles, 10000);
    </script>
</body>
</html>
